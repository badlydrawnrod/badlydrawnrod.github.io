<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>How to save and restore Windows console modes</title>
	
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Lora">
	<link rel="stylesheet" href="/css/style.css">
	
</head>
<body>
	<header class="wrapper">
    <nav>
        <a href="https://badlydrawnrod.github.io">Home</a>
        <ul>
			
            
            <li><a href="/page/about/">About</a></li>
            
            <li><a href="/posts/">All posts</a></li>
            
        </ul>
    </nav>
    
</header>
	
<main class="wrapper">
    <article>
        <p></p>
        
        <div class="date">12 August, 2020</div>
        
        <div>
            <p>How do you save and restore console modes in Windows?</p>
<h1 id="problem">Problem</h1>
<p>You&rsquo;re writing a console application in <strong>Windows</strong> and would like to change the console behaviour and restore it later.</p>
<h1 id="solution">Solution</h1>
<h2 id="wrap-setconsolemode-in-a-handle-object">Wrap <code>SetConsoleMode()</code> in a handle object</h2>
<p>This doesn&rsquo;t need much explanation. It uses a handle class whose constructor preserves the current console mode, then sets the new mode, and whose destructor puts the mode back to its original value.</p>
<h3 id="constructor">Constructor</h3>
<p>The constructor preserves the current mode, then sets and resets the desired flags.</p>
<ol>
<li>
<p>Use <a href="https://docs.microsoft.com/en-us/windows/console/getstdhandle"><code>GetStdHandle()</code></a> to get a handle for the appropriate console device.</p>
</li>
<li>
<p>Use <a href="https://docs.microsoft.com/en-us/windows/console/getconsolemode"><code>GetConsoleMode()</code></a> to read and preserve the current mode.</p>
</li>
<li>
<p>Use <a href="https://docs.microsoft.com/en-us/windows/console/setconsolemode"><code>SetConsoleMode()</code></a> to change the mode.</p>
</li>
</ol>
<h3 id="destructor">Destructor</h3>
<p>The destructor restores the mode that was previously preserved by the constructor.</p>
<ol>
<li>
<p>Use <a href="https://docs.microsoft.com/en-us/windows/console/getstdhandle"><code>GetStdHandle()</code></a> to get a handle for the desired console device.</p>
</li>
<li>
<p>Use <a href="https://docs.microsoft.com/en-us/windows/console/setconsolemode"><code>SetConsoleMode()</code></a> to set the console mode back to its original value.</p>
</li>
</ol>
<h2 id="code">Code</h2>
<p><strong>ConsoleMode.h</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00f">#pragma once
</span><span style="color:#00f">#include</span> <span style="color:#00f">&lt;Windows.h&gt;</span><span style="color:#00f">
</span><span style="color:#00f"></span>
<span style="color:#00f">class</span> <span style="color:#2b91af">ConsoleMode</span>
{
<span style="color:#00f">public</span>:
    <span style="color:#008000">// Valid console devices.
</span><span style="color:#008000"></span>    <span style="color:#00f">enum</span> <span style="color:#00f">class</span> <span style="color:#2b91af">Device</span> : DWORD
    {
        input = STD_INPUT_HANDLE,
        output = STD_OUTPUT_HANDLE,
        error = STD_ERROR_HANDLE
    };

    <span style="color:#00f">explicit</span> ConsoleMode(Device device, DWORD flagsToSet, DWORD flagsToClear);
    ~ConsoleMode();

    ConsoleMode(<span style="color:#00f">const</span> ConsoleMode&amp;) = <span style="color:#00f">delete</span>;
    ConsoleMode&amp; <span style="color:#00f">operator</span>=(<span style="color:#00f">const</span> ConsoleMode&amp;) = <span style="color:#00f">delete</span>;

    ConsoleMode(ConsoleMode&amp;&amp;) = <span style="color:#00f">delete</span>;
    ConsoleMode&amp; <span style="color:#00f">operator</span>=(ConsoleMode&amp;&amp;) = <span style="color:#00f">delete</span>;

<span style="color:#00f">private</span>:
    Device device_;
    DWORD previousMode_;
};
</code></pre></div><hr>
<p><strong>ConsoleMode.cpp</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00f">#include</span> <span style="color:#00f">&#34;ConsoleMode.h&#34;</span><span style="color:#00f">
</span><span style="color:#00f"></span>
<span style="color:#00f">#include</span> <span style="color:#00f">&lt;stdexcept&gt;</span><span style="color:#00f">
</span><span style="color:#00f"></span>
ConsoleMode::ConsoleMode(Device device, DWORD flagsToSet, DWORD flagsToClear) : device_{device}
{
    <span style="color:#008000">// Get a handle to the console device.
</span><span style="color:#008000"></span>    HANDLE handle = GetStdHandle(<span style="color:#00f">static_cast</span>&lt;DWORD&gt;(device_));
    <span style="color:#00f">if</span> (handle == <span style="color:#00f">nullptr</span> || handle == INVALID_HANDLE_VALUE)
    {
        <span style="color:#00f">throw</span> std::runtime_error(<span style="color:#a31515">&#34;Can&#39;t get handle to console device&#34;</span>);
    }

    <span style="color:#008000">// Get the current console mode and save it.
</span><span style="color:#008000"></span>    DWORD currentMode = 0;
    <span style="color:#00f">if</span> (!GetConsoleMode(handle, &amp;currentMode))
    {
        <span style="color:#00f">throw</span> std::runtime_error(<span style="color:#a31515">&#34;Can&#39;t get current console device mode&#34;</span>);
    }
    previousMode_ = currentMode;

    <span style="color:#008000">// Change the console mode.
</span><span style="color:#008000"></span>    currentMode |= flagsToSet;
    currentMode &amp;= ~flagsToClear;
    <span style="color:#00f">if</span> (!SetConsoleMode(handle, currentMode))
    {
        <span style="color:#008000">// It failed, so do our best to put it back how it was before bailing.
</span><span style="color:#008000"></span>        SetConsoleMode(handle, previousMode_);
        <span style="color:#00f">throw</span> std::runtime_error(<span style="color:#a31515">&#34;Can&#39;t set console mode&#34;</span>);
    }
}

ConsoleMode::~ConsoleMode()
{
    <span style="color:#008000">// Restore the console mode to its previous value.
</span><span style="color:#008000"></span>    HANDLE handle = GetStdHandle(<span style="color:#00f">static_cast</span>&lt;DWORD&gt;(device_));
    <span style="color:#00f">if</span> (handle != <span style="color:#00f">nullptr</span> &amp;&amp; handle != INVALID_HANDLE_VALUE)
    {
        SetConsoleMode(handle, previousMode_);
    }
}
</code></pre></div><h2 id="usage">Usage</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#00f">#include</span> <span style="color:#00f">&#34;ConsoleMode.h&#34;</span><span style="color:#00f">
</span><span style="color:#00f"></span>
<span style="color:#00f">#include</span> <span style="color:#00f">&lt;Windows.h&gt;</span><span style="color:#00f">
</span><span style="color:#00f"></span>
<span style="color:#2b91af">void</span> RunConsoleModeApp()
{
    <span style="color:#008000">// Change the console input mode. The console input mode will be restored when inputMode
</span><span style="color:#008000"></span>    <span style="color:#008000">// goes out of scope.
</span><span style="color:#008000"></span>    ConsoleMode inputMode(
        ConsoleMode::Device::input,
        ENABLE_WINDOW_INPUT | ENABLE_EXTENDED_FLAGS | ENABLE_MOUSE_INPUT,
        ENABLE_LINE_INPUT | ENABLE_ECHO_INPUT | ENABLE_PROCESSED_INPUT | ENABLE_QUICK_EDIT_MODE);

    <span style="color:#008000">// Change the console output mode. The console output mode will be restored when outputMode
</span><span style="color:#008000"></span>    <span style="color:#008000">// goes out of scope.
</span><span style="color:#008000"></span>    ConsoleMode outputMode(
        ConsoleMode::Device::output,
        ENABLE_VIRTUAL_TERMINAL_PROCESSING | DISABLE_NEWLINE_AUTO_RETURN,
        0);
    
    <span style="color:#008000">// Put your console mode application here. Who knows, maybe it&#39;ll be the next NetHack.
</span><span style="color:#008000"></span>}
</code></pre></div>
        </div>
        
        <div>
            <ul id="tags">
                
                <li><a href="/tags/howto">howto</a></li>
                
                <li><a href="/tags/console">console</a></li>
                
                <li><a href="/tags/windows">windows</a></li>
                
                <li><a href="/tags/c&#43;&#43;">c&#43;&#43;</a></li>
                
            </ul>
        </div>
        
    </article>
</main>
<aside class="wrapper">
    <div>
        <div>
            <h3>Latest Posts</h3>
        </div>
        <div>
            <ul>
                
                <li><a href="/posts/2021/11/28/why_arviss/">Why I wrote Arviss</a></li>
                
                <li><a href="/posts/2021/11/15/how-i-went-to-c/">How I went to C</a></li>
                
                <li><a href="/posts/2021/11/12/in-the-beginning/">In the beginning</a></li>
                
                <li><a href="/posts/2020/08/23/handles/">How to expose typesafe handles in a C API</a></li>
                
                <li><a href="/posts/2020/08/15/">How to save and restore Windows console modes</a></li>
                
            </ul>
        </div>
    </div>
</aside> 
	<footer class="wrapper">
	<p>&copy; 2021 <a href="https://badlydrawnrod.github.io">Badly Drawn Rod</a></p>
</footer>

</body>
</html>
