<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Let&#39;s build a virtual machine: Part 8 - Using a C compiler</title>
	
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Lora">
	<link rel="stylesheet" href="/css/style.css">
	
</head>
<body>
	<header class="wrapper">
    <nav>
        <a href="http://localhost:1313/">Home</a>
        <ul>
			
            
            <li><a href="/page/about/">About</a></li>
            
            <li><a href="/posts/">All posts</a></li>
            
        </ul>
    </nav>
    
</header>
	
<main class="wrapper">
    <article>
        <p></p>
        
        <div class="date">20 August, 2024</div>
        
        <div>
            <p>Using a C compiler to create programs for an Owl-2820 VM.</p>
<h1 id="part-8-using-a-c-compiler-to-create-owl-2820-programs">Part 8 Using a C compiler to create Owl-2820 programs</h1>
<p>In the <a href="http://localhost:1313/posts/2024/07/30/lbavm-007/">previous post</a>, we completed the implementation of the Owl-2820 instruction set.</p>
<p>I finished the post with a suggestion that we could write programs for our Owl-2820 VM in a language such as C, C++, Rust or Swift, and that we could do this by first compiling them for a RISC-V RV32I target, then somehow running the result on our Owl VM.</p>
<p>From our point of view, it would be ideal if a compiler such as <code>clang</code> or <code>gcc</code> could build for an Owl-2820 target. But, given that the Owl-2820 is a virtual CPU that exists for the purpose of this series of blog posts, it would be somewhat presumptuous to ask compiler authors to add an Owl-2820 back end to their compilers.</p>
<p>How, then, are we going to compile C programs for the Owl-2820 CPU? The answer is that we aren&rsquo;t - at least not directly. Instead, we&rsquo;re going to do this in a two stage process.</p>
<ol>
<li>Compiling C for a RISC-V target.</li>
<li>Translating the result for the Owl-280 CPU.</li>
</ol>
<h1 id="compiling-c-for-a-risc-v-target">Compiling C for a RISC-V target</h1>
<p>Both <code>clang</code> and <code>gcc</code> support compiling C for a RISC-V target. In this post we&rsquo;re going to use <code>clang</code>, simply because it supports cross-compilation out of the box. In other words, once we&rsquo;ve installed <code>clang</code> and some of the tools that go with it, then we&rsquo;ll be ready to go.</p>
<p>For a simple project like this it is very easy to use <code>clang</code> as a cross-compiler. At the time of writing I&rsquo;ve successfully compiled C programs for a RISC-V target using <code>clang</code> on Windows, on Linux, on a Raspberry Pi, and on <code>termux</code> on an Android tablet. The command line was almost identical in each case.</p>
<p>But where do we start? What C program can we compile that will run on our Owl-2820 VM?</p>
<h2 id="fibonacci-in-c">Fibonacci in C</h2>
<p>It will probably be of no surprise to you that we&rsquo;re going to compile our <a href="http://localhost:1313/posts/2024/03/17/lbavm-000-intro/#fibonacci-in-c">original Fibonacci implementation from part 0</a>. However, as we don&rsquo;t yet have an implementation for <code>printf()</code>, we will lean on the <code>PrintFib</code> system call from <a href="http://localhost:1313/posts/2024/07/21/lbavm-006/">part 6</a> to help us out, and call it from a <code>print_fib()</code> function implemented in C. For the time being we&rsquo;ll skip over its implementation, but we will return to it later in this post.</p>
<p>Here&rsquo;s the code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">#include</span> <span style="color:#00f">&lt;stdint.h&gt;</span><span style="color:#00f">
</span></span></span><span style="display:flex;"><span><span style="color:#00f"></span>
</span></span><span style="display:flex;"><span><span style="color:#008000">// We don&#39;t have an implementation of print_fib() yet. We&#39;ll come back to this.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span><span style="color:#2b91af">void</span> print_fib(<span style="color:#2b91af">uint32_t</span> i, <span style="color:#2b91af">uint32_t</span> result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">static</span> <span style="color:#2b91af">uint32_t</span> fib(<span style="color:#2b91af">uint32_t</span> n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">if</span> (n &lt; 2)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> n;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">uint32_t</span> previous = 0;
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">uint32_t</span> current = 1;
</span></span><span style="display:flex;"><span>    <span style="color:#00f">for</span> (; n &gt; 1; --n)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">uint32_t</span> next = current + previous;
</span></span><span style="display:flex;"><span>        previous = current;
</span></span><span style="display:flex;"><span>        current = next;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> current;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#2b91af">int</span> main(<span style="color:#2b91af">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">for</span> (<span style="color:#2b91af">uint32_t</span> i = 0; i &lt; 48; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">uint32_t</span> result = fib(i);
</span></span><span style="display:flex;"><span>        print_fib(i, result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> 0;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="compiling-to-risc-v-assembly-language">Compiling to RISC-V assembly language</h2>
<h3 id="command-line">Command line</h3>
<p>Let&rsquo;s compile that to RISC-V assembly language using <code>clang</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clang -S -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      -fdata-sections ./source/fib.c
</span></span></code></pre></div><h3 id="compiler-options">Compiler options</h3>
<p>Here&rsquo;s a breakdown of the command line options, with links to their full descriptions if you want more detail.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Option</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>-S</code></td>
<td style="text-align:left">only run preprocess and compile steps (i.e., don&rsquo;t assemble, don&rsquo;t link). <a href="https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html">More&hellip;</a></td>
</tr>
<tr>
<td style="text-align:left"><code>-Os</code></td>
<td style="text-align:left">enables <code>-O2</code> level optimization except those optimizations that could increase code size. <a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">More&hellip;</a></td>
</tr>
<tr>
<td style="text-align:left"><code>--target=riscv32</code></td>
<td style="text-align:left">generate code for a 32-bit RISC-V target.</td>
</tr>
<tr>
<td style="text-align:left"><code>-march=rv32i</code></td>
<td style="text-align:left">specifically target the <code>rv32i</code> architecture without any extensions. <a href="https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html">More&hellip;</a></td>
</tr>
<tr>
<td style="text-align:left"><code>-mabi=ilp32</code></td>
<td style="text-align:left">specifies that integer types (int, long, pointer) are all 32-bit and that there is no floating point. <a href="https://gcc.gnu.org/onlinedocs/gcc/RISC-V-Options.html">More&hellip;</a></td>
</tr>
<tr>
<td style="text-align:left"><code>-ffreestanding</code></td>
<td style="text-align:left">assert that the compilation takes place in a freestanding environment. <a href="https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html">More&hellip;</a></td>
</tr>
<tr>
<td style="text-align:left"><code>-ffunction-sections</code></td>
<td style="text-align:left">place each function in its own section. <a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">More&hellip;</a></td>
</tr>
<tr>
<td style="text-align:left"><code>-fdata-sections</code></td>
<td style="text-align:left">place each data in its own section. <a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">More&hellip;</a></td>
</tr>
</tbody>
</table>
<h3 id="assembly-language-output">Assembly language output</h3>
<p>That gives us some assembly language output in a file <code>fib.s</code>. I&rsquo;ve shaved off a few lines from the top and bottom, but you can see that it&rsquo;s very similar to versions of <code>fib</code> that we&rsquo;ve seen previously.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>main:                                   <span style="color:#008000"># @main
</span></span></span><span style="display:flex;"><span><span style="color:#008000"># %bb.0:
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        addi    sp, sp, -32
</span></span><span style="display:flex;"><span>        sw	    ra, 28(sp)              <span style="color:#008000"># 4-byte Folded Spill
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        sw	    s0, 24(sp)              <span style="color:#008000"># 4-byte Folded Spill
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        sw	    s1, 20(sp)              <span style="color:#008000"># 4-byte Folded Spill
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        sw	    s2, 16(sp)              <span style="color:#008000"># 4-byte Folded Spill
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        sw	    s3, 12(sp)              <span style="color:#008000"># 4-byte Folded Spill
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        li	    s0, 0
</span></span><span style="display:flex;"><span>        li	    s1, 2
</span></span><span style="display:flex;"><span>        li	    s2, 48
</span></span><span style="display:flex;"><span>        li	    s3, 1
</span></span><span style="display:flex;"><span>.LBB0_1:                                <span style="color:#008000"># =&gt;This Loop Header: Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>                                        <span style="color:#008000">#     Child Loop BB0_3 Depth 2
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        mv	    a1, s0
</span></span><span style="display:flex;"><span>        bltu	s0, s1, .LBB0_4
</span></span><span style="display:flex;"><span><span style="color:#008000"># %bb.2:                                #   in Loop: Header=BB0_1 Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        li	    a0, 0
</span></span><span style="display:flex;"><span>        li	    a1, 1
</span></span><span style="display:flex;"><span>        mv	    a2, s0
</span></span><span style="display:flex;"><span>.LBB0_3:                                <span style="color:#008000">#   Parent Loop BB0_1 Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>                                        <span style="color:#008000"># =&gt;  This Inner Loop Header: Depth=2
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        mv	    a3, a1
</span></span><span style="display:flex;"><span>        addi	a2, a2, -1
</span></span><span style="display:flex;"><span>        add	    a1, a0, a1
</span></span><span style="display:flex;"><span>        mv	    a0, a3
</span></span><span style="display:flex;"><span>        bltu	s3, a2, .LBB0_3
</span></span><span style="display:flex;"><span>.LBB0_4:                                <span style="color:#008000">#   in Loop: Header=BB0_1 Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        mv	    a0, s0
</span></span><span style="display:flex;"><span>        call	print_fib
</span></span><span style="display:flex;"><span>        addi	s0, s0, 1
</span></span><span style="display:flex;"><span>        bne	    s0, s2, .LBB0_1
</span></span><span style="display:flex;"><span><span style="color:#008000"># %bb.5:
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        li	    a0, 0
</span></span><span style="display:flex;"><span>        lw	    ra, 28(sp)              <span style="color:#008000"># 4-byte Folded Reload
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        lw	    s0, 24(sp)              <span style="color:#008000"># 4-byte Folded Reload
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        lw	    s1, 20(sp)              <span style="color:#008000"># 4-byte Folded Reload
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        lw	    s2, 16(sp)              <span style="color:#008000"># 4-byte Folded Reload
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        lw	    s3, 12(sp)              <span style="color:#008000"># 4-byte Folded Reload
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        addi	sp, sp, 32
</span></span><span style="display:flex;"><span>        ret
</span></span></code></pre></div><h2 id="compiling-to-an-object-file">Compiling to an object file</h2>
<h3 id="command-line-1">Command line</h3>
<p>If we replace the <code>-S</code> flag with <code>-c</code> then the compiler will output an object file with a <code>.o</code> extension.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clang -c -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      -fdata-sections ./source/fib.c
</span></span></code></pre></div><h3 id="compiler-options-1">Compiler options</h3>
<p>Here&rsquo;s a description of the <code>-c</code> command line option.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Option</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>-c</code></td>
<td style="text-align:left">only run the preprocess, compile and assemble steps (i.e., don&rsquo;t link). <a href="https://gcc.gnu.org/onlinedocs/gcc/Overall-Options.html">More&hellip;</a></td>
</tr>
</tbody>
</table>
<h3 id="disassembling">Disassembling</h3>
<p>We can disassemble the resulting object file, <code>fib.o</code>, with <code>llvm-objdump</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>llvm-objdump -d fib.o
</span></span></code></pre></div><p>The resulting disassembly also shows us the offset of each instruction, and how it has been encoded.</p>
<p>For example, the 8th instruction in the output, &ldquo;<code>li s1, 0x2</code>&rdquo; is at offset <code>0x1c</code> and is written into memory as <code>93 04 20 00</code> which is the little-endian representation of <code>0x00200493</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>fib.o:       file format elf32-littleriscv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section .text.main:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="">00000000</span> <span style="">&lt;</span>main<span style="">&gt;</span>:
</span></span><span style="display:flex;"><span>       <span style="">0:</span> <span style="">13</span> <span style="">01</span> <span style="">01</span> fe   addi    sp, sp, -0x20
</span></span><span style="display:flex;"><span>       <span style="">4:</span> <span style="">23</span> <span style="">2</span>e 11 00   sw      ra, 0x1c(sp)
</span></span><span style="display:flex;"><span>       <span style="">8:</span> <span style="">23</span> <span style="">2</span>c 81 00   sw      s0, 0x18(sp)
</span></span><span style="display:flex;"><span>       c: <span style="">23</span> <span style="">2</span>a 91 00   sw      s1, 0x14(sp)
</span></span><span style="display:flex;"><span>      <span style="">10:</span> <span style="">23</span> <span style="">28</span> <span style="">21</span> <span style="">01</span>   sw      s2, 0x10(sp)
</span></span><span style="display:flex;"><span>      <span style="">14:</span> <span style="">23</span> <span style="">26</span> <span style="">31</span> <span style="">01</span>   sw      s3, 0xc(sp)
</span></span><span style="display:flex;"><span>      <span style="">18:</span> <span style="">13</span> <span style="">04</span> <span style="">00</span> <span style="">00</span>   li      s0, 0x0
</span></span><span style="display:flex;"><span>      <span style="">1</span>c: <span style="">93</span> <span style="">04</span> <span style="">20</span> <span style="">00</span>   li      s1, 0x2
</span></span><span style="display:flex;"><span>      <span style="">20:</span> <span style="">13</span> <span style="">09</span> <span style="">00</span> <span style="">03</span>   li      s2, 0x30
</span></span><span style="display:flex;"><span>      <span style="">24:</span> <span style="">93</span> <span style="">09</span> <span style="">10</span> <span style="">00</span>   li      s3, 0x1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="">00000028</span> <span style="">&lt;</span>.LBB0_1<span style="">&gt;</span>:
</span></span><span style="display:flex;"><span>      <span style="">28:</span> <span style="">93</span> <span style="">05</span> <span style="">04</span> <span style="">00</span>   mv      a1, s0
</span></span><span style="display:flex;"><span>      <span style="">2</span>c: <span style="">63</span> <span style="">60</span> <span style="">94</span> <span style="">00</span>   bltu    s0, s1, 0x2c &lt;.LBB0_1+0x4&gt;
</span></span><span style="display:flex;"><span>      <span style="">30:</span> <span style="">13</span> <span style="">05</span> <span style="">00</span> <span style="">00</span>   li      a0, 0x0
</span></span><span style="display:flex;"><span>      <span style="">34:</span> <span style="">93</span> <span style="">05</span> <span style="">10</span> <span style="">00</span>   li      a1, 0x1
</span></span><span style="display:flex;"><span>      <span style="">38:</span> <span style="">13</span> <span style="">06</span> <span style="">04</span> <span style="">00</span>   mv      a2, s0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="">0000003</span>c <span style="">&lt;</span>.LBB0_3<span style="">&gt;</span>:
</span></span><span style="display:flex;"><span>      <span style="">3</span>c: <span style="">93</span> <span style="">86</span> <span style="">05</span> <span style="">00</span>   mv      a3, a1
</span></span><span style="display:flex;"><span>      <span style="">40:</span> <span style="">13</span> <span style="">06</span> f6 ff   addi    a2, a2, -0x1
</span></span><span style="display:flex;"><span>      <span style="">44:</span> b3 05 b5 00   add     a1, a0, a1
</span></span><span style="display:flex;"><span>      <span style="">48:</span> <span style="">13</span> <span style="">85</span> <span style="">06</span> <span style="">00</span>   mv      a0, a3
</span></span><span style="display:flex;"><span>      <span style="">4</span>c: <span style="">63</span> e0 c9 00   bltu    s3, a2, 0x4c &lt;.LBB0_3+0x10&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="">00000050</span> <span style="">&lt;</span>.LBB0_4<span style="">&gt;</span>:
</span></span><span style="display:flex;"><span>      <span style="">50:</span> <span style="">13</span> <span style="">05</span> <span style="">04</span> <span style="">00</span>   mv      a0, s0
</span></span><span style="display:flex;"><span>      <span style="">54:</span> <span style="">97</span> <span style="">00</span> <span style="">00</span> <span style="">00</span>   auipc   ra, 0x0
</span></span><span style="display:flex;"><span>      <span style="">58:</span> e7 80 00 00   jalr    ra &lt;.LBB0_4+0x4&gt;
</span></span><span style="display:flex;"><span>      <span style="">5</span>c: <span style="">13</span> <span style="">04</span> <span style="">14</span> <span style="">00</span>   addi    s0, s0, 0x1
</span></span><span style="display:flex;"><span>      <span style="">60:</span> <span style="">63</span> <span style="">10</span> <span style="">24</span> <span style="">01</span>   bne     s0, s2, 0x60 &lt;.LBB0_4+0x10&gt;
</span></span><span style="display:flex;"><span>      <span style="">64:</span> <span style="">13</span> <span style="">05</span> <span style="">00</span> <span style="">00</span>   li      a0, 0x0
</span></span><span style="display:flex;"><span>      <span style="">68:</span> <span style="">83</span> <span style="">20</span> c1 01   lw      ra, 0x1c(sp)
</span></span><span style="display:flex;"><span>      <span style="">6</span>c: <span style="">03</span> <span style="">24</span> <span style="">81</span> <span style="">01</span>   lw      s0, 0x18(sp)
</span></span><span style="display:flex;"><span>      <span style="">70:</span> <span style="">83</span> <span style="">24</span> <span style="">41</span> <span style="">01</span>   lw      s1, 0x14(sp)
</span></span><span style="display:flex;"><span>      <span style="">74:</span> <span style="">03</span> <span style="">29</span> <span style="">01</span> <span style="">01</span>   lw      s2, 0x10(sp)
</span></span><span style="display:flex;"><span>      <span style="">78:</span> <span style="">83</span> <span style="">29</span> c1 00   lw      s3, 0xc(sp)
</span></span><span style="display:flex;"><span>      <span style="">7</span>c: <span style="">13</span> <span style="">01</span> <span style="">01</span> <span style="">02</span>   addi    sp, sp, 0x20
</span></span><span style="display:flex;"><span>      <span style="">80:</span> <span style="">67</span> <span style="">80</span> <span style="">00</span> <span style="">00</span>   ret
</span></span></code></pre></div><h2 id="linking">Linking</h2>
<h3 id="command-line-2">Command line</h3>
<p>All we have so far is an object file, not an executable. Let&rsquo;s take it further by removing the <code>-c</code> flag so that the compiler will also run the link step to generate a binary executable.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clang -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      -fdata-sections ./source/fib.c
</span></span></code></pre></div><h3 id="output">Output</h3>
<p>The linker complains about not being able to find certain libraries.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ld.lld: error: unable to find library -lc
</span></span><span style="display:flex;"><span>ld.lld: error: unable to find library -lm
</span></span><span style="display:flex;"><span>ld.lld: error: unable to find library -lclang_rt.builtins-riscv32
</span></span><span style="display:flex;"><span>clang: error: ld.lld command failed with exit code 1 (use -v to see invocation)
</span></span></code></pre></div><h3 id="fixing-the-build">Fixing the build</h3>
<p>We&rsquo;re not using any of these libraries, so we can inform it of that with more command line options.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clang -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      -fdata-sections ./source/fib.c -nostdlib -nodefaultlibs
</span></span></code></pre></div><h3 id="command-line-options">Command line options</h3>
<p>Here&rsquo;s what those options mean.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Option</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>-nostdlib</code></td>
<td style="text-align:left">do not use the standard system library startup files or libraries when linking.  <a href="https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html">More&hellip;</a></td>
</tr>
<tr>
<td style="text-align:left"><code>-nodefaultlibs</code></td>
<td style="text-align:left">do not use the standard system libraries when linking. <a href="https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html">More&hellip;</a></td>
</tr>
</tbody>
</table>
<h3 id="output-1">Output</h3>
<p>However, the linker still complains because we don&rsquo;t have an implementation of <code>print_fib()</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ld.lld: error: undefined symbol: print_fib
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; referenced by fib.c
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;               C:\Users\myname\AppData\Local\Temp\fib-751f97.o:(main)
</span></span><span style="display:flex;"><span>clang: error: ld.lld command failed with exit code 1 (use -v to see invocation)
</span></span></code></pre></div><h2 id="implementing-print_fib">Implementing print_fib()</h2>
<p>We need an implementation of <code>print_fib()</code>. In <a href="http://localhost:1313/posts/2024/07/21/lbavm-006/">part 6</a>, we added a <code>PrintFib</code> system call which we called from a <code>print_fib</code> subroutine.</p>
<p>System calls are implemented in the Owl-2820 VM by putting the syscall number in the <em>a7</em> register, placing up to seven arguments in the <em>a0</em> to <em>a6</em> registers, then invoking the <code>ecall</code> instruction.</p>
<p>For <code>PrintFib</code>, we have two arguments, passed in the <em>a0</em> and <em>a1</em> registers. Here&rsquo;s a reminder of its implementation.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#00f">while</span> (!done)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#008000">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#00f">switch</span> (opcode)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#00f">case</span> Opcode::Ecall: {
</span></span><span style="display:flex;"><span>            <span style="color:#00f">const</span> <span style="color:#00f">auto</span> syscall = Syscall(x[a7]);
</span></span><span style="display:flex;"><span>            <span style="color:#00f">switch</span> (syscall)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#008000">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#00f">case</span> Syscall::PrintFib:
</span></span><span style="display:flex;"><span>                std::cout &lt;&lt; std::format(<span style="color:#a31515">&#34;fib({}) = {}</span><span style="color:#a31515">\n</span><span style="color:#a31515">&#34;</span>, x[a0], x[a1]);
</span></span><span style="display:flex;"><span>                <span style="color:#00f">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#00f">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre></div><p>And here&rsquo;s how we implemented the <code>print_fib</code> subroutine in Owl-2820 assembly language. The <a href="http://localhost:1313/posts/2024/06/11/lbavm-004/#calling-conventions">calling convention from part 4</a> means that we can pass the arguments to <code>print_fib</code> in registers <em>a0</em> and <em>a1</em> and it doesn&rsquo;t have to do anything more beyond putting the syscall number into register <em>a7</em>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>print_fib:
</span></span><span style="display:flex;"><span>        li      a7, 1                   <span style="color:#008000"># set a7 to 1, i.e., PrintFib
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        ecall                           <span style="color:#008000"># invoke the syscall
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        ret                             <span style="color:#008000"># return from print_fib
</span></span></span></code></pre></div><p>How can we do the same from C?</p>
<h3 id="inline-assembly-language">Inline assembly language</h3>
<p>We could write <code>print_fib</code> in assembly language, for example, by putting the above code into a file <code>print_fib.s</code> and compiling it alongside our C program. That would probably work, some of the time&hellip; maybe?</p>
<p>In reality, we should be very reluctant to do that because the C compiler would have no way of knowing which registers were required by our assembly language <code>print_fib</code> implementation, nor would it know which values will be overwritten.</p>
<p>However, if we write <code>print_fib()</code> in terms of inline assembly language in C, then we can provide that information to the compiler.</p>
<p>Let&rsquo;s do that now, and add the following implementation of <code>print_fib()</code> to the top of our C program.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#00f">#include</span> <span style="color:#00f">&lt;stdint.h&gt;</span><span style="color:#00f">
</span></span></span><span style="display:flex;"><span><span style="color:#00f"></span>
</span></span><span style="display:flex;"><span><span style="color:#00f">static</span> <span style="color:#00f">inline</span> <span style="color:#2b91af">void</span> print_fib(<span style="color:#2b91af">uint32_t</span> i, <span style="color:#2b91af">uint32_t</span> result)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// Define local register variables and associate them with specific RISC-V registers.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">// See: https://gcc.gnu.org/onlinedocs/gcc/Local-Register-Variables.html
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">//
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">register</span> <span style="color:#2b91af">uint32_t</span> a7 __asm__(<span style="color:#a31515">&#34;a7&#34;</span>) = 1;      <span style="color:#008000">// a7 = syscall number
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">register</span> <span style="color:#2b91af">uint32_t</span> a0 __asm__(<span style="color:#a31515">&#34;a0&#34;</span>) = i;      <span style="color:#008000">// a0 = first argument to syscall
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#00f">register</span> <span style="color:#2b91af">uint32_t</span> a1 __asm__(<span style="color:#a31515">&#34;a1&#34;</span>) = result; <span style="color:#008000">// a1 = second argument to syscall
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#008000">// Invoke the `PrintFib` syscall.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">//
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">// See: https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">//      https://gcc.gnu.org/onlinedocs/gcc/Simple-Constraints.html
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">//      https://gcc.gnu.org/onlinedocs/gcc/Modifiers.html
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">// and: https://www.felixcloutier.com/documents/gcc-asm.html
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    <span style="color:#008000">//
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    __asm__ __volatile__(<span style="color:#a31515">&#34;ecall /* Do a syscall */&#34;</span>  <span style="color:#008000">// assembler template: ecall (with a comment)
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>                         : <span style="color:#a31515">&#34;+r&#34;</span>(a0)                  <span style="color:#008000">// output operands: reads and writes a0
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>                         : <span style="color:#a31515">&#34;r&#34;</span>(a7), <span style="color:#a31515">&#34;r&#34;</span>(a0), <span style="color:#a31515">&#34;r&#34;</span>(a1) <span style="color:#008000">// input operands: reads a7, a0, a1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>                         : <span style="color:#a31515">&#34;memory&#34;</span>);                <span style="color:#008000">// clobbers: this instruction may modify memory
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>}
</span></span></code></pre></div><p>That seems quite verbose for a couple of lines of assembly language, but it is ultimately necessary to tell the C compiler exactly how we&rsquo;re going to use the registers. Rather than explaining this in extreme detail, I&rsquo;ve put some explanatory links in the code.</p>
<h3 id="compiling-to-assembly-language">Compiling to assembly language</h3>
<p>Let&rsquo;s compile the program with the <code>-S</code> flag so that we can see the resulting assembly language and prove to ourselves that <code>print_fib()</code> is implemented as a syscall.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clang -S -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      -fdata-sections ./source/fib.c
</span></span></code></pre></div><h3 id="output-2">Output</h3>
<p>Here&rsquo;s the assembly language output containing our <code>print_fib</code> implementation.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>main:                                   <span style="color:#008000"># @main
</span></span></span><span style="display:flex;"><span><span style="color:#008000"># %bb.0:
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        li	    a2, 0
</span></span><span style="display:flex;"><span>        li	    a3, 2
</span></span><span style="display:flex;"><span>        li	    a4, 1
</span></span><span style="display:flex;"><span>        li	    a5, 48
</span></span><span style="display:flex;"><span>.LBB0_1:                                <span style="color:#008000"># =&gt;This Loop Header: Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>                                        <span style="color:#008000">#     Child Loop BB0_3 Depth 2
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        mv	    a1, a2
</span></span><span style="display:flex;"><span>        bltu	a2, a3, .LBB0_4
</span></span><span style="display:flex;"><span><span style="color:#008000"># %bb.2:                                #   in Loop: Header=BB0_1 Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        li	    a0, 0
</span></span><span style="display:flex;"><span>        li	    a1, 1
</span></span><span style="display:flex;"><span>        mv	    a6, a2
</span></span><span style="display:flex;"><span>.LBB0_3:                                <span style="color:#008000">#   Parent Loop BB0_1 Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>                                        <span style="color:#008000"># =&gt;  This Inner Loop Header: Depth=2
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        mv	    a7, a1
</span></span><span style="display:flex;"><span>        addi	a6, a6, -1
</span></span><span style="display:flex;"><span>        add	    a1, a0, a1
</span></span><span style="display:flex;"><span>        mv	    a0, a7
</span></span><span style="display:flex;"><span>        bltu	a4, a6, .LBB0_3
</span></span><span style="display:flex;"><span>.LBB0_4:                                <span style="color:#008000">#   in Loop: Header=BB0_1 Depth=1
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        li	    a7, 1
</span></span><span style="display:flex;"><span>        mv	    a0, a2
</span></span><span style="display:flex;"><span>        <span style="color:#008000">#APP
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        ecall   <span style="color:#008000"># Do a syscall
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        <span style="color:#008000">#NO_APP
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        addi	a2, a2, 1
</span></span><span style="display:flex;"><span>        bne	    a2, a5, .LBB0_1
</span></span><span style="display:flex;"><span><span style="color:#008000"># %bb.5:
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        li	a0, 0
</span></span><span style="display:flex;"><span>        ret
</span></span></code></pre></div><p>It hasn&rsquo;t changed much from the <a href="#assembly-language-output">assembly language output</a> that we saw earlier, except that <code>call print_fib</code> has been replaced with an inlined version of our <code>print_fib()</code> function, i.e., this piece of code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>        li	    a7, 1                   <span style="color:#008000"># set a7 to 1, i.e., PrintFib
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        mv	    a0, a2                  <span style="color:#008000"># copy `i` into `a0`
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>        ecall                           <span style="color:#008000"># invoke the syscall
</span></span></span></code></pre></div><p>Those of you with a keen eye may have spotted that it doesn&rsquo;t actually set register <em>a1</em> to anything, and that&rsquo;s because <em>a1</em> already contains the correct value. Optimizing compilers are clever.</p>
<h2 id="the-_start-entry-point">The _start entry point</h2>
<h3 id="command-line-3">Command line</h3>
<p>So, having added <code>print_fib()</code>, let&rsquo;s try linking again.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clang -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      -fdata-sections ./source/fib.c -nostdlib -nodefaultlibs
</span></span></code></pre></div><h3 id="output-3">Output</h3>
<p>This time we get a warning, but nothing more.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>ld.lld: warning: cannot find entry symbol _start; not setting start address
</span></span></code></pre></div><h3 id="a-simple-runtime">A simple runtime</h3>
<p>At this point, some of you are nodding your heads wisely, and others are asking, &ldquo;What? I thought C programs start at <code>main()</code>&rdquo;.</p>
<p>Well, yes, <code>main()</code> may well be the entry point as far as your C program is concerned, but that&rsquo;s not the entry point for an <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a> binary, which is what we have here.</p>
<p>By default the entry point for an ELF binary is named <code>_start</code>. It is responsible, among other things, for calling <code>main()</code> and providing it with <code>argc</code> and <code>argv</code>, and (assuming that there is one) returning control back to the operating system when done. When we added the <code>--nostdlib</code> option to the command line then we effectively told the compiler that we&rsquo;ll be doing that ourselves.</p>
<p>We&rsquo;ll create our own <code>_start</code> in assembly language and put it in a file named <code>crt0.s</code>. Our implementation of <code>_start</code> is very cut down; it calls <code>main()</code> then it exits via the <code>Exit</code> syscall. And because we&rsquo;re calling <em>into</em> a C program, we can control exactly which registers are used, so there&rsquo;s no need to embed this in C.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>    .section .init
</span></span><span style="display:flex;"><span>    .global _start
</span></span><span style="display:flex;"><span>    .type   _start, @function
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_start:
</span></span><span style="display:flex;"><span>    .cfi_startproc
</span></span><span style="display:flex;"><span>    .cfi_undefined ra
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#008000"># Call main().
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    li		a0,0        <span style="color:#008000"># a0 = argc = 0
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    li		a1,0		<span style="color:#008000"># a1 = argv = NULL
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    li		a2,0		<span style="color:#008000"># a2 = envp = NULL
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    call    main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#008000"># Exit.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    li      a0,0        <span style="color:#008000"># a0 = exit code
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    li      a7,0        <span style="color:#008000"># a7 = syscall number (0 is exit)
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>    ecall               <span style="color:#008000"># do a syscall. There&#39;s no coming back from this one.
</span></span></span><span style="display:flex;"><span><span style="color:#008000"></span>
</span></span><span style="display:flex;"><span>    .cfi_endproc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .size  _start, .-_start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    .end
</span></span></code></pre></div><h3 id="command-line-4">Command line</h3>
<p>Let&rsquo;s add <code>crt0.s</code> to the command line and try again.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> clang -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>       -fdata-sections ./source/crt0.s ./source/fib.c -nostdlib -nodefaultlibs
</span></span></code></pre></div><h3 id="disassembling-1">Disassembling</h3>
<p>The good news is that it compiles without warning. Let&rsquo;s disassemble it with <code>llvm-objdump</code>, using the <code>-f</code> flag to display the ELF file headers so that we can see what the program&rsquo;s start address is.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>llvm-objump -f -d a.out
</span></span></code></pre></div><p>The program&rsquo;s start address, <code>0x00011154</code>, is the same as that of <code>_start</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>a.out:  file format elf32-littleriscv
</span></span><span style="display:flex;"><span>architecture: riscv32
</span></span><span style="display:flex;"><span>start address: 0x00011154
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section .text:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>00011100 &lt;main&gt;:
</span></span><span style="display:flex;"><span>   11100: 13 06 00 00   li      a2, 0x0
</span></span><span style="display:flex;"><span>   11104: 93 06 20 00   li      a3, 0x2
</span></span><span style="display:flex;"><span>   11108: 13 07 10 00   li      a4, 0x1
</span></span><span style="display:flex;"><span>   1110c: 93 07 00 03   li      a5, 0x30
</span></span><span style="display:flex;"><span>   11110: 93 05 06 00   mv      a1, a2
</span></span><span style="display:flex;"><span>   11114: 63 62 d6 02   bltu    a2, a3, 0x11138 &lt;main+0x38&gt;
</span></span><span style="display:flex;"><span>   11118: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>   1111c: 93 05 10 00   li      a1, 0x1
</span></span><span style="display:flex;"><span>   11120: 13 08 06 00   mv      a6, a2
</span></span><span style="display:flex;"><span>   11124: 93 88 05 00   mv      a7, a1
</span></span><span style="display:flex;"><span>   11128: 13 08 f8 ff   addi    a6, a6, -0x1
</span></span><span style="display:flex;"><span>   1112c: b3 05 b5 00   add     a1, a0, a1
</span></span><span style="display:flex;"><span>   11130: 13 85 08 00   mv      a0, a7
</span></span><span style="display:flex;"><span>   11134: e3 68 07 ff   bltu    a4, a6, 0x11124 &lt;main+0x24&gt;
</span></span><span style="display:flex;"><span>   11138: 93 08 10 00   li      a7, 0x1
</span></span><span style="display:flex;"><span>   1113c: 13 05 06 00   mv      a0, a2
</span></span><span style="display:flex;"><span>   11140: 73 00 00 00   ecall
</span></span><span style="display:flex;"><span>   11144: 13 06 16 00   addi    a2, a2, 0x1
</span></span><span style="display:flex;"><span>   11148: e3 14 f6 fc   bne     a2, a5, 0x11110 &lt;main+0x10&gt;
</span></span><span style="display:flex;"><span>   1114c: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>   11150: 67 80 00 00   ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section .init:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>00011154 &lt;_start&gt;:
</span></span><span style="display:flex;"><span>   11154: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>   11158: 93 05 00 00   li      a1, 0x0
</span></span><span style="display:flex;"><span>   1115c: 13 06 00 00   li      a2, 0x0
</span></span><span style="display:flex;"><span>   11160: ef f0 1f fa   jal     0x11100 &lt;main&gt;
</span></span><span style="display:flex;"><span>   11164: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>   11168: 93 08 00 00   li      a7, 0x0
</span></span><span style="display:flex;"><span>   1116c: 73 00 00 00   ecall
</span></span></code></pre></div><p>This is a problem, because our Owl-2820 VM assumes that all programs start at address <code>0x00000000</code>. We need to find a way to move <code>_start</code> to that address, and to place <code>main</code> somewhere following it.</p>
<h2 id="specifying-section-addresses">Specifying section addresses</h2>
<p>If you look at the disassembly above, you&rsquo;ll see that <code>_start</code> is in a section named <code>.init</code>, and <code>main</code> is in a section named <code>.text</code>. So we need the <code>.init</code> section which contains <code>_start</code> to start at address <code>0x00000000</code>, and the <code>.text</code> section which contains <code>main</code> to start a bit later in memory, e.g., at address <code>0x00000100</code>.</p>
<h3 id="command-line-5">Command line</h3>
<p>We can use the the linker option <code>--section-start</code> to specify the starting addresses of the <code>.init</code> and <code>.text</code> sections.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>clang -Os --target=riscv32 -march=rv32i -mabi=ilp32 -ffreestanding -ffunction-sections <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      -fdata-sections ./source/crt0.s ./source/fib.c -nostdlib -nodefaultlibs <span style="color:#a31515">\
</span></span></span><span style="display:flex;"><span><span style="color:#a31515"></span>      <span style="color:#a31515">&#34;-Wl,--section-start=.init=0&#34;</span> <span style="color:#a31515">&#34;-Wl,--section-start=.text=100&#34;</span>
</span></span></code></pre></div><h3 id="compiler-options-2">Compiler options</h3>
<p>The <code>-Wl</code> option is used to pass options to the linker.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Option</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>-Wl,</code></td>
<td style="text-align:left">pass a comma separated list of options to the linker. <a href="https://gcc.gnu.org/onlinedocs/gcc/Link-Options.html">More&hellip;</a></td>
</tr>
</tbody>
</table>
<h3 id="linker-options">Linker options</h3>
<p>The <code>--section-start</code> linker option specifies the start address, in hex, of a named section.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Linker Option</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>--section-start=&lt;name&gt;=&lt;addr&gt;</code></td>
<td style="text-align:left">set the start address of section <code>&lt;name&gt;</code> to hexadecimal address <code>&lt;addr&gt;</code>. <a href="https://linux.die.net/man/1/ld">More&hellip;</a></td>
</tr>
</tbody>
</table>
<h3 id="disassembling-2">Disassembling</h3>
<p>Let&rsquo;s disassemble the resulting ELF binary.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>llvm-objump -f -d a.out
</span></span></code></pre></div><p>This time we have the result that we want. The program&rsquo;s start address is now <code>0x00000000</code>. The <code>.init</code> section which contains <code>_start</code> is also at address <code>0x00000000</code>. Similarly, the <code>.text</code> section which contains <code>main</code> is at address <code>0x00000100</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>a.out:  file format elf32-littleriscv
</span></span><span style="display:flex;"><span>architecture: riscv32
</span></span><span style="display:flex;"><span>start address: 0x00000000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section .init:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>00000000 &lt;_start&gt;:
</span></span><span style="display:flex;"><span>       0: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>       4: 93 05 00 00   li      a1, 0x0
</span></span><span style="display:flex;"><span>       8: 13 06 00 00   li      a2, 0x0
</span></span><span style="display:flex;"><span>       c: ef 00 40 0f   jal     0x100 &lt;main&gt;
</span></span><span style="display:flex;"><span>      10: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>      14: 93 08 00 00   li      a7, 0x0
</span></span><span style="display:flex;"><span>      18: 73 00 00 00   ecall
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section .text:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>00000100 &lt;main&gt;:
</span></span><span style="display:flex;"><span>     100: 13 06 00 00   li      a2, 0x0
</span></span><span style="display:flex;"><span>     104: 93 06 20 00   li      a3, 0x2
</span></span><span style="display:flex;"><span>     108: 13 07 10 00   li      a4, 0x1
</span></span><span style="display:flex;"><span>     10c: 93 07 00 03   li      a5, 0x30
</span></span><span style="display:flex;"><span>     110: 93 05 06 00   mv      a1, a2
</span></span><span style="display:flex;"><span>     114: 63 62 d6 02   bltu    a2, a3, 0x138 &lt;main+0x38&gt;
</span></span><span style="display:flex;"><span>     118: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>     11c: 93 05 10 00   li      a1, 0x1
</span></span><span style="display:flex;"><span>     120: 13 08 06 00   mv      a6, a2
</span></span><span style="display:flex;"><span>     124: 93 88 05 00   mv      a7, a1
</span></span><span style="display:flex;"><span>     128: 13 08 f8 ff   addi    a6, a6, -0x1
</span></span><span style="display:flex;"><span>     12c: b3 05 b5 00   add     a1, a0, a1
</span></span><span style="display:flex;"><span>     130: 13 85 08 00   mv      a0, a7
</span></span><span style="display:flex;"><span>     134: e3 68 07 ff   bltu    a4, a6, 0x124 &lt;main+0x24&gt;
</span></span><span style="display:flex;"><span>     138: 93 08 10 00   li      a7, 0x1
</span></span><span style="display:flex;"><span>     13c: 13 05 06 00   mv      a0, a2
</span></span><span style="display:flex;"><span>     140: 73 00 00 00   ecall
</span></span><span style="display:flex;"><span>     144: 13 06 16 00   addi    a2, a2, 0x1
</span></span><span style="display:flex;"><span>     148: e3 14 f6 fc   bne     a2, a5, 0x110 &lt;main+0x10&gt;
</span></span><span style="display:flex;"><span>     14c: 13 05 00 00   li      a0, 0x0
</span></span><span style="display:flex;"><span>     150: 67 80 00 00   ret
</span></span></code></pre></div><h2 id="extracting-an-image">Extracting an image</h2>
<p>Finally, we have an ELF format executable with our code at the addresses that we want it to be. At this point, we could write an ELF loader that will parse the <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format#File_layout">ELF file</a> and load the relevant parts of the program into our VM&rsquo;s memory.</p>
<p>It is reasonably straightforward to write a rudimentary ELF loader, but it takes a lot more effort to write a secure one, as you have to be very careful with the values that you accept from the file. If you&rsquo;re not careful, then your ELF loader could end up reading a maliciously crafted ELF file that subverts it in some way. For example, one of the fields might contain an offset that&rsquo;s beyond the length of the image. If your ELF loader accepts that field without checking it, or adds it to an integer which then overflows, then you&rsquo;re on a slippery slope to memory corruption.</p>
<p>Fortunately, our use case is very simple, so we don&rsquo;t need to write an ELF loader. Instead, we can use <code>llvm-objcopy</code> to extract a binary image from the ELF file. We can then load that binary image straight into our VM&rsquo;s memory.</p>
<h3 id="command-line-6">Command line</h3>
<p>Here we have to tell <code>llvm-objcopy</code> which sections to extract, otherwise it will include several sections that are of no interest to us.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>llvm-objcopy a.out -O binary a.bin -j .init -j .text
</span></span></code></pre></div><p>The <code>-j</code> flag tells <code>llvm-objcopy</code> which sections we want to include in the image.</p>
<p>At this point we just want the <code>.init</code> section and the <code>.text</code> section. When we develop larger programs then we&rsquo;ll also want to add other sections, such as <code>.rodata</code> for read-only data, but we have no need of them at this point.</p>
<h3 id="viewing-the-image">Viewing the image</h3>
<p>Running <code>llvm-objcopy</code> created an image, <code>a.bin</code>. If we dump that in hex then we can see that the image contains the hex values from the <code>.init</code> section starting at offset <code>00000000</code>, followed by the hex values from the <code>.text</code> section starting at offset <code>00000100</code>.</p>
<p>Here&rsquo;s some Powershell to dump the image. If you&rsquo;re on Linux then <code>hd</code> will do the trick.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>format-hex a.bin
</span></span></code></pre></div><h3 id="output-4">Output</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>           00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>00000000   13 05 00 00 93 05 00 00 13 06 00 00 EF 00 40 0F  ...........ï.@.
</span></span><span style="display:flex;"><span>00000010   13 05 00 00 93 08 00 00 73 00 00 00 00 00 00 00  .......s.......
</span></span><span style="display:flex;"><span>00000020   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000030   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000040   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000050   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000060   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000070   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000080   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000090   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>000000A0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>000000B0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>000000C0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>000000D0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>000000E0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>000000F0   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
</span></span><span style="display:flex;"><span>00000100   13 06 00 00 93 06 20 00 13 07 10 00 93 07 00 03  ..... ........
</span></span><span style="display:flex;"><span>00000110   93 05 06 00 63 62 D6 02 13 05 00 00 93 05 10 00  ...cbÖ........
</span></span><span style="display:flex;"><span>00000120   13 08 06 00 93 88 05 00 13 08 F8 FF B3 05 B5 00  ........ø.³.µ.
</span></span><span style="display:flex;"><span>00000130   13 85 08 00 E3 68 07 FF 93 08 10 00 13 05 06 00  ...ãh.........
</span></span><span style="display:flex;"><span>00000140   73 00 00 00 13 06 16 00 E3 14 F6 FC 13 05 00 00  s.......ã.öü....
</span></span><span style="display:flex;"><span>00000150   67 80 00 00                                      g..
</span></span></code></pre></div><p>And there we have it. One binary image, ready to load into our Owl-2820 VM&rsquo;s memory. Or is it?</p>
<h2 id="translating-the-result-for-the-owl-2820-cpu">Translating the result for the Owl-2820 CPU</h2>
<p>Well, there is the small matter of instruction encoding.</p>
<p>Owl-2820 shares the same instruction set as RV32I, but it encodes the instructions differently so that they are <a href="http://localhost:1313/posts/2024/04/02/lbavm-001/#comparing-risc-v-encoding-with-owl-encoding">easy to decode and dispatch in software</a>.</p>
<p>We either need to re-encode the instructions from RISC-V instruction encoding into Owl-2820 instruction encoding, or we need to modify our Owl-2820 VM to understand the RISC-V instruction encoding.</p>
<p>That will be the topic for the next post.</p>
        </div>
        
        <div>
            <ul id="tags">
                
                <li><a href="/tags/vm">vm</a></li>
                
                <li><a href="/tags/owl">owl</a></li>
                
            </ul>
        </div>
        
    </article>
</main>
<aside class="wrapper">
    <div>
        <div>
            <h3>Latest Posts</h3>
        </div>
        <div>
            <ul>
                
                <li><a href="/posts/2024/08/25/lbavm-008/">Let&#39;s build a virtual machine: Part 8 - Using a C compiler</a></li>
                
                <li><a href="/posts/2024/07/30/lbavm-007/">Let&#39;s build a virtual machine: Part 7 - Draw the rest of the Owl</a></li>
                
                <li><a href="/posts/2024/07/21/lbavm-006/">Let&#39;s build a virtual machine: Part 6 - System calls</a></li>
                
                <li><a href="/posts/2024/07/05/lbavm-005/">Let&#39;s build a virtual machine: Part 5 - Memory</a></li>
                
                <li><a href="/posts/2024/06/11/lbavm-004/">Let&#39;s build a virtual machine: Part 4 - Call, return, and calling conventions</a></li>
                
            </ul>
        </div>
    </div>
</aside> 
	<footer class="wrapper">
	<p>&copy; 2024 <a href="http://localhost:1313/">My Badly Drawn Self</a></p>
</footer>

</body>
</html>
